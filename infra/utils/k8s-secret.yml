---

- block:
    - name: Gather Kubernetes Credentials
      command: "kops get secrets kube --type secret -oplaintext"
      register: k8s_credentials_fetch
      changed_when: false
    - name: Cache Kubernetes Credentials
      set_fact:
        k8s_credentials: "{{ k8s_credentials_fetch.stdout }}"
  when: k8s_credentials is not defined
- name: Store Kubernetes Secret
  kubernetes:
    api_endpoint: "api.{{ k8s_url }}"
    username: admin
    password: "{{ k8s_credentials }}"
    inline_data: |
      {% set secretName = secret.name %}
      {% set secret_items = secret.entries %}
      {% include 'utils/k8s-secret.yml.j2' %}
